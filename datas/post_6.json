{"html":"<h2>起因</h2>\n<p>最近在用Z-library，下载了一些epub电子书，用Neat Reader看，Neat Reader好是好，但是一些自定义样式要VIP。</p>\n<p>但我可是有着从未在网络上用一分钱购买任何虚拟产品的纪录的，于是我就想，我可不可以自己做一个epub解析器</p>\n<h2>思路</h2>\n<p>我从Z-library下载的epub电子书是application/epub+zip格式，首先我需要把它解压，目录大概是这样：</p>\n<pre><code class=\"hljs\">images/\n- 00001.jpeg\n- 00002.jpeg\n- ...\nMETA-INF/\n- container.xml\ntext/\n- part0001.html\n- part0002.html\n- ...\ncontent.opf\ncover.jpeg\nmimetype\npage_styles.css\nstylesheet.css\ntitlepage.xhtml\ntoc.ncx</code></pre><p>epub的所有资源的索引就在content.opf(xml)里，同时也包括这本电子书的名字、作者、出版社、封面等信息</p>\n<p>toc.ncx(xml)放的是目录</p>\n<p>文字内容是html的形式，正好方便了解析查看。</p>\n<p>所以我们只需解压epub然后读取content.opf建立文件索引，然后读取toc.ncx目录，之后再渲染到网页上就可以了。</p>\n<h2>实现</h2>\n<h3>解压</h3>\n<p>解压我用的是zip.js</p>\n<pre><code class=\"hljs hljs-javascript\"><span class=\"hljs-keyword\">var</span> epubblob=inputfile.<span class=\"hljs-property\">files</span>[<span class=\"hljs-number\">0</span>];\n<span class=\"hljs-keyword\">var</span> reader=<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">ZipReader</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">BlobReader</span>(epubblob));\n<span class=\"hljs-keyword\">var</span> entries = <span class=\"hljs-keyword\">await</span> reader.<span class=\"hljs-title function_\">getEntries</span>()\n<span class=\"hljs-comment\">/*\n[\n  {\n    filename:&quot;dir/file&quot;,\n    getData:Function\n  }\n]\n */</span></code></pre><h3>解析 content.opf</h3>\n<pre><code class=\"hljs hljs-javascript\">  <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">getFile</span>(<span class=\"hljs-params\">entries,path</span>){\n      <span class=\"hljs-keyword\">return</span> entries.<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entry</span>){\n            <span class=\"hljs-keyword\">return</span> entry.<span class=\"hljs-property\">filename</span>==path\n        })\n  }\n\n  <span class=\"hljs-keyword\">var</span> xml=<span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">getFile</span>(entries,<span class=\"hljs-string\">&#x27;content.opf&#x27;</span>).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">TextWriter</span>());\n  <span class=\"hljs-keyword\">var</span> domparser=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMParser</span>();\n  <span class=\"hljs-keyword\">var</span> doc=domparser.<span class=\"hljs-title function_\">parseFromString</span>(xml,<span class=\"hljs-string\">&#x27;text/html&#x27;</span>);\n  doc=doc.<span class=\"hljs-property\">documentElement</span>;\n\n  <span class=\"hljs-comment\">// 标题</span>\n  <span class=\"hljs-keyword\">var</span> title=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:title&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n\n  <span class=\"hljs-comment\">// 作者</span>\n  <span class=\"hljs-keyword\">var</span> writer=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:creator&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n\n  <span class=\"hljs-comment\">// 发行日期</span>\n  <span class=\"hljs-keyword\">var</span> date=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:date&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n\n  <span class=\"hljs-comment\">// 出版社</span>\n  <span class=\"hljs-keyword\">var</span> publisher=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:publisher&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n\n  <span class=\"hljs-comment\">// 语言</span>\n  <span class=\"hljs-keyword\">var</span> lang=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:language&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n\n  <span class=\"hljs-comment\">// 文件索引</span>\n  <span class=\"hljs-keyword\">var</span> items=doc.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;manifest item&#x27;</span>);\n  <span class=\"hljs-keyword\">var</span> itemObj={};\n  <span class=\"hljs-keyword\">var</span> cover,titlepage;\n  <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">var</span> i=<span class=\"hljs-number\">0</span>;i&lt;items.<span class=\"hljs-property\">length</span>;i++){\n      <span class=\"hljs-keyword\">var</span> item=items[i];\n      <span class=\"hljs-keyword\">if</span>(!item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)){\n          <span class=\"hljs-keyword\">return</span> ;\n      }\n      <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;id&#x27;</span>)==<span class=\"hljs-string\">&#x27;cover&#x27;</span>){\n          cover=item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>);\n      }\n      <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;id&#x27;</span>)==<span class=\"hljs-string\">&#x27;titlepage&#x27;</span>){\n          titlepage=item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>);\n      }\n      <span class=\"hljs-comment\">// 判断图片</span>\n      <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.jpg&#x27;</span>)||item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.png&#x27;</span>)||item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.gif&#x27;</span>)||item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.jpeg&#x27;</span>)){\n          itemObj[item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)]=<span class=\"hljs-variable constant_\">URL</span>.<span class=\"hljs-title function_\">createObjectURL</span>(<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getFile</span>(entries,item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">BlobWriter</span>()));\n      }<span class=\"hljs-keyword\">else</span>{\n          itemObj[item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)]=<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getFile</span>(entries,item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">TextWriter</span>());\n      }\n  }\n  \n  <span class=\"hljs-keyword\">let</span> epubData={\n      <span class=\"hljs-attr\">title</span>:title,\n      <span class=\"hljs-attr\">writer</span>:writer,\n      <span class=\"hljs-attr\">date</span>:date,\n      <span class=\"hljs-attr\">publisher</span>:publisher,\n      <span class=\"hljs-attr\">lang</span>:lang,\n      <span class=\"hljs-attr\">itemObj</span>:itemObj,\n      <span class=\"hljs-attr\">cover</span>:itemObj[cover],\n      <span class=\"hljs-attr\">titlepage</span>:titlepage\n  };</code></pre><h3>解析toc.ncx</h3>\n<pre><code class=\"hljs hljs-javascript\"><span class=\"hljs-keyword\">var</span> xml=<span class=\"hljs-keyword\">await</span> entries.<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entry</span>){\n    <span class=\"hljs-keyword\">return</span> entry.<span class=\"hljs-property\">filename</span>==<span class=\"hljs-string\">&#x27;toc.ncx&#x27;</span>;\n}).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">TextWriter</span>());\n\n<span class=\"hljs-keyword\">var</span> doc=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMParser</span>().<span class=\"hljs-title function_\">parseFromString</span>(xml,<span class=\"hljs-string\">&#x27;text/html&#x27;</span>);<span class=\"hljs-comment\">// 用text/html更方便</span>\n<span class=\"hljs-keyword\">var</span> navmap=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;navmap&#x27;</span>);\n\n<span class=\"hljs-comment\">// 遍历目录</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">g</span>(<span class=\"hljs-params\">items</span>){\n    <span class=\"hljs-keyword\">var</span> toc=[];\n    items.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">item</span>){\n        <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">nodeType</span>==<span class=\"hljs-number\">1</span>){\n            <span class=\"hljs-keyword\">var</span> a={};\n            <span class=\"hljs-keyword\">var</span> childNodes=item.<span class=\"hljs-property\">childNodes</span>;\n            childNodes.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">item</span>){\n                <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">nodeType</span>==<span class=\"hljs-number\">1</span>){\n                    <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">tagName</span>==<span class=\"hljs-string\">&#x27;NAVLABEL&#x27;</span>){\n                      <span class=\"hljs-comment\">//标题</span>\n                        a.<span class=\"hljs-property\">label</span>=item.<span class=\"hljs-property\">textContent</span>.<span class=\"hljs-title function_\">trim</span>();\n                    }<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">tagName</span>==<span class=\"hljs-string\">&#x27;CONTENT&#x27;</span>){\n                        <span class=\"hljs-keyword\">var</span> href=item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>).<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n                        <span class=\"hljs-comment\">//索引</span>\n                        a.<span class=\"hljs-property\">href</span>=href[<span class=\"hljs-number\">0</span>];\n\n                        href.<span class=\"hljs-title function_\">shift</span>();\n                        <span class=\"hljs-comment\">// 定位</span>\n                        a.<span class=\"hljs-property\">hash</span>=href.<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n                        <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;NAVPOINT&#x27;</span>)){\n                            a.<span class=\"hljs-property\">list</span>=<span class=\"hljs-title function_\">g</span>(item.<span class=\"hljs-property\">childNodes</span>);<span class=\"hljs-comment\">//遍历子目录</span>\n                        }\n                    }\n                } \n            });\n            toc.<span class=\"hljs-title function_\">push</span>(a);\n        }                \n      })\n      <span class=\"hljs-keyword\">return</span> toc;\n}\n\nepubData.<span class=\"hljs-property\">toc</span>=<span class=\"hljs-title function_\">g</span>(navmap.<span class=\"hljs-property\">childNodes</span>);</code></pre><h3>渲染</h3>\n<p>做一个container</p>\n<pre><code class=\"hljs hljs-javascript\"><span class=\"hljs-keyword\">var</span> epubContainer=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>);\nepubContainer.<span class=\"hljs-property\">className</span>=<span class=\"hljs-string\">&#x27;epub-container&#x27;</span>;\nepubContainer.<span class=\"hljs-property\">innerHTML</span>=<span class=\"hljs-string\">&#x27;&lt;div class=&quot;epub-toc&quot;&gt;&lt;div class=&quot;epub-toc-list&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;epub-content&quot;&gt;&lt;/div&gt;&#x27;</span>;\n<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">body</span>.<span class=\"hljs-title function_\">appendChild</span>(epubContainer);</code></pre><p>渲染目录</p>\n<pre><code class=\"hljs hljs-javascript\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">gtoc</span>(<span class=\"hljs-params\">n,r</span>){\n  r.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n      <span class=\"hljs-keyword\">var</span> a=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>);\n      a.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">&#x27;epub-toc-item&#x27;</span>);\n      a.<span class=\"hljs-property\">innerText</span>=e.<span class=\"hljs-property\">label</span>;\n      a.<span class=\"hljs-title function_\">setAttribute</span>(<span class=\"hljs-string\">&#x27;data-href&#x27;</span>,e.<span class=\"hljs-property\">href</span>);\n      a.<span class=\"hljs-title function_\">setAttribute</span>(<span class=\"hljs-string\">&#x27;data-hash&#x27;</span>,e.<span class=\"hljs-property\">hash</span>);\n      n.<span class=\"hljs-title function_\">appendChild</span>(a);\n      a.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&#x27;click&#x27;</span>,<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>){\n          <span class=\"hljs-keyword\">var</span> t=a.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;data-href&#x27;</span>);\n          <span class=\"hljs-keyword\">var</span> i=a.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;data-hash&#x27;</span>);\n          epubContainer.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;.epub-toc-item&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">a</span>){\n              a.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">remove</span>(<span class=\"hljs-string\">&#x27;active&#x27;</span>);\n          })\n          a.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">&#x27;active&#x27;</span>);\n          <span class=\"hljs-title function_\">view</span>(t,i) <span class=\"hljs-comment\">// 见下方</span>\n      });\n      <span class=\"hljs-keyword\">if</span>(e.<span class=\"hljs-property\">list</span>){\n          <span class=\"hljs-keyword\">var</span> b=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>);\n          b.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">&#x27;epub-toc-list&#x27;</span>);\n          n.<span class=\"hljs-title function_\">appendChild</span>(b);\n          <span class=\"hljs-title function_\">gtoc</span>(b,e.<span class=\"hljs-property\">list</span>); <span class=\"hljs-comment\">// 渲染子目录</span>\n      }\n  })\n}\n<span class=\"hljs-comment\">// 遍历渲染目录</span>\n<span class=\"hljs-title function_\">gtoc</span>(epubContainer.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;.epub-toc-list&#x27;</span>),epubData.<span class=\"hljs-property\">toc</span>);</code></pre><p>渲染内容</p>\n<pre><code class=\"hljs hljs-javascript\"><span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">epubNowShow</span>=<span class=\"hljs-literal\">null</span>;\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">view</span>(<span class=\"hljs-params\">t,i</span>){\n  <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">epubNowShow</span>!=t){\n      <span class=\"hljs-keyword\">var</span> html=epubData.<span class=\"hljs-property\">itemObj</span>[t];\n      <span class=\"hljs-keyword\">var</span> d=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMParser</span>().<span class=\"hljs-title function_\">parseFromString</span>(html,<span class=\"hljs-string\">&#x27;text/html&#x27;</span>);\n      <span class=\"hljs-comment\">// 获取所有图片并根据索引替换成对应已解析数据</span>\n      d.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;img&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n          e.<span class=\"hljs-property\">src</span>=epubData.<span class=\"hljs-property\">itemObj</span>[e.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-string\">&#x27;../&#x27;</span>,<span class=\"hljs-string\">&#x27;&#x27;</span>)];  \n      });\n      <span class=\"hljs-comment\">// 获取所有样式并添加到网页</span>\n      d.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;link[rel=stylesheet]&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n          <span class=\"hljs-keyword\">var</span> s=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;style&#x27;</span>);\n          s.<span class=\"hljs-property\">innerHTML</span>=epubData.<span class=\"hljs-property\">itemObj</span>[e.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-string\">&#x27;../&#x27;</span>,<span class=\"hljs-string\">&#x27;&#x27;</span>)];\n          <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">head</span>.<span class=\"hljs-title function_\">appendChild</span>(s);\n      });\n      \n      <span class=\"hljs-comment\">//获取标题</span>\n      <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">title</span>=d.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;title&#x27;</span>).<span class=\"hljs-property\">innerText</span>;\n\n      <span class=\"hljs-comment\">// 填充内容</span>\n      o.<span class=\"hljs-property\">innerHTML</span>=d.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">innerHTML</span>;\n      o.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;a&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n          e.<span class=\"hljs-property\">onclick</span>=<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">ev</span>){\n              ev.<span class=\"hljs-title function_\">preventDefault</span>();\n              <span class=\"hljs-comment\">// 渲染锚点链接</span>\n              <span class=\"hljs-keyword\">var</span> h=e.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n              h.<span class=\"hljs-title function_\">shift</span>();\n              <span class=\"hljs-keyword\">var</span> i=h.<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n              <span class=\"hljs-keyword\">try</span> {\n                  o.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>+i).<span class=\"hljs-title function_\">scrollIntoView</span>();\n              } <span class=\"hljs-keyword\">catch</span> (error) {\n                  \n              }\n          }\n      });\n      <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">epubNowShow</span>=t;\n  }\n  <span class=\"hljs-keyword\">try</span> {\n      o.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>+i).<span class=\"hljs-title function_\">scrollIntoView</span>();\n  } <span class=\"hljs-keyword\">catch</span> (error) {\n      \n  }\n}\n<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">title</span>=epubData.<span class=\"hljs-property\">title</span>;\no.<span class=\"hljs-property\">innerHTML</span>=<span class=\"hljs-string\">`&lt;div class=&quot;epub_info_show&quot;&gt;\n  &lt;img src=&quot;<span class=\"hljs-subst\">${epubData.cover}</span>&quot;/&gt;\n  &lt;p class=&quot;title&quot;&gt;<span class=\"hljs-subst\">${epubData.title}</span>&lt;/p&gt;\n  &lt;p class=&quot;writer&quot;&gt;<span class=\"hljs-subst\">${epubData.writer}</span>&lt;/p&gt;\n  &lt;p class=&quot;publisher&quot;&gt;<span class=\"hljs-subst\">${epubData.publisher}</span>&lt;/p&gt;\n&lt;/div&gt;`</span></code></pre><h2>封装</h2>\n<p>把所有代码封装到一起：</p>\n<pre><code class=\"hljs hljs-javascript\"><span class=\"hljs-keyword\">var</span> epubjs = {\n    <span class=\"hljs-attr\">view</span>:<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>){\n        <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">epubNowShow</span>=<span class=\"hljs-literal\">null</span>;\n        <span class=\"hljs-keyword\">var</span> epubContainer=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>);\n        epubContainer.<span class=\"hljs-property\">className</span>=<span class=\"hljs-string\">&#x27;epub-container&#x27;</span>;\n        epubContainer.<span class=\"hljs-property\">innerHTML</span>=<span class=\"hljs-string\">&#x27;&lt;div class=&quot;epub-toc&quot;&gt;&lt;div class=&quot;epub-toc-list&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;epub-content&quot;&gt;&lt;/div&gt;&#x27;</span>;\n        <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">body</span>.<span class=\"hljs-title function_\">appendChild</span>(epubContainer);\n        <span class=\"hljs-keyword\">var</span> o=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;.epub-content&#x27;</span>);\n        <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">gtoc</span>(<span class=\"hljs-params\">n,r</span>){\n            r.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n                <span class=\"hljs-keyword\">var</span> a=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>);\n                a.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">&#x27;epub-toc-item&#x27;</span>);\n                a.<span class=\"hljs-property\">innerText</span>=e.<span class=\"hljs-property\">label</span>;\n                a.<span class=\"hljs-title function_\">setAttribute</span>(<span class=\"hljs-string\">&#x27;data-href&#x27;</span>,e.<span class=\"hljs-property\">href</span>);\n                a.<span class=\"hljs-title function_\">setAttribute</span>(<span class=\"hljs-string\">&#x27;data-hash&#x27;</span>,e.<span class=\"hljs-property\">hash</span>);\n                n.<span class=\"hljs-title function_\">appendChild</span>(a);\n                a.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&#x27;click&#x27;</span>,<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>){\n                    <span class=\"hljs-keyword\">var</span> t=a.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;data-href&#x27;</span>);\n                    <span class=\"hljs-keyword\">var</span> i=a.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;data-hash&#x27;</span>);\n                    epubContainer.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;.epub-toc-item&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">a</span>){\n                        a.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">remove</span>(<span class=\"hljs-string\">&#x27;active&#x27;</span>);\n                    })\n                    a.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">&#x27;active&#x27;</span>);\n                    <span class=\"hljs-title function_\">view</span>(t,i)\n                });\n                <span class=\"hljs-keyword\">if</span>(e.<span class=\"hljs-property\">list</span>){\n                    <span class=\"hljs-keyword\">var</span> b=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;div&#x27;</span>);\n                    b.<span class=\"hljs-property\">classList</span>.<span class=\"hljs-title function_\">add</span>(<span class=\"hljs-string\">&#x27;epub-toc-list&#x27;</span>);\n                    n.<span class=\"hljs-title function_\">appendChild</span>(b);\n                    <span class=\"hljs-title function_\">gtoc</span>(b,e.<span class=\"hljs-property\">list</span>);\n                }\n            })\n        }\n        <span class=\"hljs-title function_\">gtoc</span>(epubContainer.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;.epub-toc-list&#x27;</span>),res.<span class=\"hljs-property\">toc</span>);\n        <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">view</span>(<span class=\"hljs-params\">t,i</span>){\n            <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">epubNowShow</span>!=t){\n                <span class=\"hljs-keyword\">var</span> html=res.<span class=\"hljs-property\">itemObj</span>[t];\n                <span class=\"hljs-keyword\">var</span> d=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMParser</span>().<span class=\"hljs-title function_\">parseFromString</span>(html,<span class=\"hljs-string\">&#x27;text/html&#x27;</span>);\n                d.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;img&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n                    e.<span class=\"hljs-property\">src</span>=res.<span class=\"hljs-property\">itemObj</span>[e.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-string\">&#x27;../&#x27;</span>,<span class=\"hljs-string\">&#x27;&#x27;</span>)];  \n                });\n                d.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;link[rel=stylesheet]&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n                    <span class=\"hljs-keyword\">var</span> s=<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-string\">&#x27;style&#x27;</span>);\n                    s.<span class=\"hljs-property\">innerHTML</span>=res.<span class=\"hljs-property\">itemObj</span>[e.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-string\">&#x27;../&#x27;</span>,<span class=\"hljs-string\">&#x27;&#x27;</span>)];\n                    <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">head</span>.<span class=\"hljs-title function_\">appendChild</span>(s);\n                });\n                \n                <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">title</span>=d.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;title&#x27;</span>).<span class=\"hljs-property\">innerText</span>;\n                o.<span class=\"hljs-property\">innerHTML</span>=d.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">innerHTML</span>;\n                o.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;a&#x27;</span>).<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">e</span>){\n                    e.<span class=\"hljs-property\">onclick</span>=<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">ev</span>){\n                        ev.<span class=\"hljs-title function_\">preventDefault</span>();\n                        <span class=\"hljs-keyword\">var</span> h=e.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n                        h.<span class=\"hljs-title function_\">shift</span>();\n                        <span class=\"hljs-keyword\">var</span> i=h.<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n                        <span class=\"hljs-keyword\">try</span> {\n                            o.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>+i).<span class=\"hljs-title function_\">scrollIntoView</span>();\n                        } <span class=\"hljs-keyword\">catch</span> (error) {\n                            \n                        }\n                    }\n                });\n                <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">epubNowShow</span>=t;\n            }\n            <span class=\"hljs-keyword\">try</span> {\n                o.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>+i).<span class=\"hljs-title function_\">scrollIntoView</span>();\n            } <span class=\"hljs-keyword\">catch</span> (error) {\n                \n            }\n        }\n        <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">title</span>=res.<span class=\"hljs-property\">title</span>;\n        o.<span class=\"hljs-property\">innerHTML</span>=<span class=\"hljs-string\">`&lt;div class=&quot;epub_info_show&quot;&gt;\n            &lt;img src=&quot;<span class=\"hljs-subst\">${res.cover}</span>&quot;/&gt;\n            &lt;p class=&quot;title&quot;&gt;<span class=\"hljs-subst\">${res.title}</span>&lt;/p&gt;\n            &lt;p class=&quot;writer&quot;&gt;<span class=\"hljs-subst\">${res.writer}</span>&lt;/p&gt;\n            &lt;p class=&quot;publisher&quot;&gt;<span class=\"hljs-subst\">${res.publisher}</span>&lt;/p&gt;\n        &lt;/div&gt;`</span>\n    },\n    <span class=\"hljs-attr\">parse</span>:<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">path</span>) {\n        <span class=\"hljs-keyword\">var</span> readerm;\n        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">typeof</span> path==<span class=\"hljs-string\">&#x27;string&#x27;</span>){\n            readerm = <span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">HttpReader</span>(path);\n        }<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(path <span class=\"hljs-keyword\">instanceof</span> <span class=\"hljs-title class_\">Blob</span>){\n            readerm = <span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">BlobReader</span>(path);\n        }\n        <span class=\"hljs-keyword\">var</span> reader = <span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">ZipReader</span>(readerm);\n        <span class=\"hljs-keyword\">var</span> entries = <span class=\"hljs-keyword\">await</span> reader.<span class=\"hljs-title function_\">getEntries</span>()\n        <span class=\"hljs-keyword\">var</span> contentOpf=<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getContentOpf</span>(entries);\n        <span class=\"hljs-keyword\">var</span> toc=<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getToc</span>(entries);\n        contentOpf.<span class=\"hljs-property\">toc</span>=toc;\n        <span class=\"hljs-keyword\">return</span> contentOpf\n    },\n    <span class=\"hljs-attr\">getContentOpf</span>:<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entries</span>){\n        <span class=\"hljs-keyword\">var</span> xml=<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getFile</span>(entries,<span class=\"hljs-string\">&#x27;content.opf&#x27;</span>).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">TextWriter</span>());\n        <span class=\"hljs-keyword\">var</span> domparser=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMParser</span>();\n        <span class=\"hljs-keyword\">var</span> doc=domparser.<span class=\"hljs-title function_\">parseFromString</span>(xml,<span class=\"hljs-string\">&#x27;text/html&#x27;</span>);\n        doc=doc.<span class=\"hljs-property\">documentElement</span>;\n        <span class=\"hljs-keyword\">var</span> title=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:title&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n        <span class=\"hljs-keyword\">var</span> writer=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:creator&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n        <span class=\"hljs-keyword\">var</span> date=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:date&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n        <span class=\"hljs-keyword\">var</span> publisher=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:publisher&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n        <span class=\"hljs-keyword\">var</span> lang=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;dc\\\\:language&#x27;</span>).<span class=\"hljs-property\">textContent</span>;\n        <span class=\"hljs-keyword\">var</span> items=doc.<span class=\"hljs-title function_\">querySelectorAll</span>(<span class=\"hljs-string\">&#x27;manifest item&#x27;</span>);\n        <span class=\"hljs-keyword\">var</span> itemObj={};\n        <span class=\"hljs-keyword\">var</span> cover,titlepage;\n        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">var</span> i=<span class=\"hljs-number\">0</span>;i&lt;items.<span class=\"hljs-property\">length</span>;i++){\n            <span class=\"hljs-keyword\">var</span> item=items[i];\n            <span class=\"hljs-keyword\">if</span>(!item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)){\n                <span class=\"hljs-keyword\">return</span> ;\n            }\n            <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;id&#x27;</span>)==<span class=\"hljs-string\">&#x27;cover&#x27;</span>){\n                cover=item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>);\n            }\n            <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;id&#x27;</span>)==<span class=\"hljs-string\">&#x27;titlepage&#x27;</span>){\n                titlepage=item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>);\n            }\n            <span class=\"hljs-comment\">// 判断图片</span>\n            <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.jpg&#x27;</span>)||item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.png&#x27;</span>)||item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.gif&#x27;</span>)||item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>).<span class=\"hljs-title function_\">endsWith</span>(<span class=\"hljs-string\">&#x27;.jpeg&#x27;</span>)){\n                itemObj[item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)]=<span class=\"hljs-variable constant_\">URL</span>.<span class=\"hljs-title function_\">createObjectURL</span>(<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getFile</span>(entries,item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">BlobWriter</span>()));\n            }<span class=\"hljs-keyword\">else</span>{\n                itemObj[item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)]=<span class=\"hljs-keyword\">await</span> epubjs.<span class=\"hljs-title function_\">getFile</span>(entries,item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;href&#x27;</span>)).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">TextWriter</span>());\n            }\n        }\n        <span class=\"hljs-keyword\">return</span> {\n            <span class=\"hljs-attr\">title</span>:title,\n            <span class=\"hljs-attr\">writer</span>:writer,\n            <span class=\"hljs-attr\">date</span>:date,\n            <span class=\"hljs-attr\">publisher</span>:publisher,\n            <span class=\"hljs-attr\">lang</span>:lang,\n            <span class=\"hljs-attr\">itemObj</span>:itemObj,\n            <span class=\"hljs-attr\">cover</span>:itemObj[cover],\n            <span class=\"hljs-attr\">titlepage</span>:titlepage\n        };\n    },\n    <span class=\"hljs-attr\">getToc</span>:<span class=\"hljs-keyword\">async</span> <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entries</span>){\n        <span class=\"hljs-keyword\">var</span> xml=<span class=\"hljs-keyword\">await</span> entries.<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entry</span>){\n            <span class=\"hljs-keyword\">return</span> entry.<span class=\"hljs-property\">filename</span>==<span class=\"hljs-string\">&#x27;toc.ncx&#x27;</span>;\n        }).<span class=\"hljs-title function_\">getData</span>(<span class=\"hljs-keyword\">new</span> zip.<span class=\"hljs-title class_\">TextWriter</span>());\n        <span class=\"hljs-keyword\">var</span> doc=<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">DOMParser</span>().<span class=\"hljs-title function_\">parseFromString</span>(xml,<span class=\"hljs-string\">&#x27;text/html&#x27;</span>);\n        <span class=\"hljs-keyword\">var</span> navmap=doc.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;navmap&#x27;</span>);\n        <span class=\"hljs-keyword\">var</span> toc=<span class=\"hljs-title function_\">g</span>(navmap.<span class=\"hljs-property\">childNodes</span>);\n        <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">g</span>(<span class=\"hljs-params\">items</span>){\n            <span class=\"hljs-keyword\">var</span> toc=[];\n            items.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">item</span>){\n                <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">nodeType</span>==<span class=\"hljs-number\">1</span>){\n                    <span class=\"hljs-keyword\">var</span> a={};\n                    <span class=\"hljs-keyword\">var</span> childNodes=item.<span class=\"hljs-property\">childNodes</span>;\n                    childNodes.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">item</span>){\n                        <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">nodeType</span>==<span class=\"hljs-number\">1</span>){\n                            <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">tagName</span>==<span class=\"hljs-string\">&#x27;NAVLABEL&#x27;</span>){\n                                a.<span class=\"hljs-property\">label</span>=item.<span class=\"hljs-property\">textContent</span>.<span class=\"hljs-title function_\">trim</span>();\n                            }<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-property\">tagName</span>==<span class=\"hljs-string\">&#x27;CONTENT&#x27;</span>){\n                                <span class=\"hljs-keyword\">var</span> href=item.<span class=\"hljs-title function_\">getAttribute</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>).<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n                                a.<span class=\"hljs-property\">href</span>=href[<span class=\"hljs-number\">0</span>];\n                                href.<span class=\"hljs-title function_\">shift</span>();\n                                a.<span class=\"hljs-property\">hash</span>=href.<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;#&#x27;</span>);\n                                <span class=\"hljs-keyword\">if</span>(item.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;NAVPOINT&#x27;</span>)){\n                                    a.<span class=\"hljs-property\">list</span>=<span class=\"hljs-title function_\">g</span>(item.<span class=\"hljs-property\">childNodes</span>);\n                                }\n                            }\n                        } \n                    });\n                    toc.<span class=\"hljs-title function_\">push</span>(a);\n                }                \n             })\n             <span class=\"hljs-keyword\">return</span> toc;\n        }\n        <span class=\"hljs-keyword\">return</span> toc;\n    },\n    <span class=\"hljs-attr\">getFile</span>:<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entries,path</span>){\n        <span class=\"hljs-keyword\">return</span> entries.<span class=\"hljs-title function_\">find</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">entry</span>){\n            <span class=\"hljs-keyword\">return</span> entry.<span class=\"hljs-property\">filename</span>==path\n        })\n    },\n    <span class=\"hljs-attr\">show</span>:<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">path</span>){\n        epubjs.<span class=\"hljs-title function_\">parse</span>(path).<span class=\"hljs-title function_\">then</span>(<span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">res</span>){\n            epubjs.<span class=\"hljs-title function_\">view</span>(res);\n        })\n    }\n}</code></pre><p>再写一下CSS:</p>\n<pre><code class=\"hljs hljs-css\"><span class=\"hljs-selector-tag\">body</span>{\n    <span class=\"hljs-attribute\">margin</span>: <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-attribute\">padding</span>: <span class=\"hljs-number\">0</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span>{\n    <span class=\"hljs-attribute\">width</span>: <span class=\"hljs-number\">100%</span>;\n    <span class=\"hljs-attribute\">height</span>: <span class=\"hljs-number\">100vh</span>;\n    <span class=\"hljs-attribute\">margin</span>: <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-attribute\">padding</span>: <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-attribute\">overflow</span>: hidden;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-toc</span>{\n    <span class=\"hljs-attribute\">width</span>: <span class=\"hljs-number\">300px</span>;\n    <span class=\"hljs-attribute\">padding</span>: <span class=\"hljs-number\">10px</span>;\n    <span class=\"hljs-attribute\">box-sizing</span>: border-box;\n    <span class=\"hljs-attribute\">height</span>: <span class=\"hljs-number\">100%</span>;\n    <span class=\"hljs-attribute\">overflow</span>:auto;\n    <span class=\"hljs-attribute\">float</span>: left;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-toc</span> <span class=\"hljs-selector-class\">.epub-toc-list</span>{\n    <span class=\"hljs-attribute\">margin-left</span>: <span class=\"hljs-number\">1em</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-toc</span>&gt;<span class=\"hljs-selector-class\">.epub-toc-list</span>{\n    <span class=\"hljs-attribute\">margin-left</span>: <span class=\"hljs-number\">0</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-toc</span> <span class=\"hljs-selector-class\">.epub-toc-item</span>{\n    <span class=\"hljs-attribute\">padding</span>: <span class=\"hljs-number\">5px</span> <span class=\"hljs-number\">3px</span>;\n    <span class=\"hljs-attribute\">margin</span>: <span class=\"hljs-number\">2px</span> <span class=\"hljs-number\">0</span>;\n    <span class=\"hljs-attribute\">cursor</span>: pointer;\n    <span class=\"hljs-attribute\">border-radius</span>: <span class=\"hljs-number\">5px</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-toc</span> <span class=\"hljs-selector-class\">.epub-toc-item</span><span class=\"hljs-selector-pseudo\">:hover</span>{\n    <span class=\"hljs-attribute\">background-color</span>: <span class=\"hljs-number\">#f5f5f5</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-toc</span> <span class=\"hljs-selector-class\">.epub-toc-item</span><span class=\"hljs-selector-class\">.active</span>{\n    <span class=\"hljs-attribute\">font-weight</span>: bold;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-content</span>{\n    <span class=\"hljs-attribute\">width</span>: <span class=\"hljs-built_in\">calc</span>(<span class=\"hljs-number\">100%</span> - <span class=\"hljs-number\">300px</span>);\n    <span class=\"hljs-attribute\">height</span>: <span class=\"hljs-number\">100%</span>;\n    <span class=\"hljs-attribute\">overflow</span>: auto;\n    <span class=\"hljs-attribute\">padding</span>: <span class=\"hljs-number\">10px</span>;\n    <span class=\"hljs-attribute\">box-sizing</span>: border-box;\n    <span class=\"hljs-attribute\">float</span>: left;\n    <span class=\"hljs-attribute\">line-height</span>: <span class=\"hljs-number\">1.5em</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-content</span> <span class=\"hljs-selector-class\">.epub_info_show</span> <span class=\"hljs-selector-tag\">img</span>{\n    <span class=\"hljs-attribute\">width</span>:<span class=\"hljs-number\">260px</span>;\n    <span class=\"hljs-attribute\">display</span>: block;\n    <span class=\"hljs-attribute\">margin</span>: <span class=\"hljs-number\">10px</span> auto;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-content</span> <span class=\"hljs-selector-class\">.epub_info_show</span> <span class=\"hljs-selector-tag\">p</span>{\n    <span class=\"hljs-attribute\">text-align</span>: center;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-content</span> <span class=\"hljs-selector-class\">.epub_info_show</span> <span class=\"hljs-selector-tag\">p</span><span class=\"hljs-selector-class\">.title</span>{\n    <span class=\"hljs-attribute\">font-size</span>: <span class=\"hljs-number\">20px</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-content</span> <span class=\"hljs-selector-class\">.epub_info_show</span> <span class=\"hljs-selector-tag\">p</span><span class=\"hljs-selector-class\">.writer</span>{\n    <span class=\"hljs-attribute\">font-size</span>: <span class=\"hljs-number\">16px</span>;\n}\n<span class=\"hljs-selector-class\">.epub-container</span> <span class=\"hljs-selector-class\">.epub-content</span> <span class=\"hljs-selector-class\">.epub_info_show</span> <span class=\"hljs-selector-tag\">p</span><span class=\"hljs-selector-class\">.publisher</span>{\n    <span class=\"hljs-attribute\">font-size</span>: <span class=\"hljs-number\">14px</span>;\n    <span class=\"hljs-attribute\">color</span>: <span class=\"hljs-number\">#aaa</span>;\n}</code></pre><p>大功告成！</p>\n<p><img src=\"https://s21.ax1x.com/2024/03/23/pFhfPAS.png\" alt=\"pFhfPAS.png\">\n<img src=\"https://s21.ax1x.com/2024/03/23/pFhfFhQ.png\" alt=\"pFhfFhQ.png\"></p>\n<h2>总结</h2>\n<p>也没有想象中那么难，至少基本的是做出来了，后面就慢慢优化样式吧。</p>\n","detail":{"title":"自制一个在线epub阅读器","time":"2024/03/23 11:22:48","id":6,"desc":"最近在用Z-library，下载了一些epub电子书，用Neat Reader看，Neat Reader好是好，但是一些自定义样式要VIP。但我可是有着从未在","tags":["JS"]}}